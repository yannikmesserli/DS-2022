<html>
  <head>
    <meta charset="utf-8" />
    <title>
      Based on: Thematic multivariate visualization (3D) | Sample | ArcGIS API for JavaScript 4.22
    </title>
    <link rel="stylesheet" href="https://js.arcgis.com/4.22/esri/themes/light/main.css" />
    <script src="https://js.arcgis.com/4.22/"></script>

    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }
    </style>

    <script>
      require([
        "esri/layers/FeatureLayer",
        "esri/layers/CSVLayer",
        "esri/Map",
        "esri/views/SceneView",
        "esri/renderers/SimpleRenderer",
        "esri/symbols/PointSymbol3D",
        "esri/symbols/IconSymbol3DLayer",
        "esri/symbols/ObjectSymbol3DLayer",
        "esri/widgets/Expand",
        "esri/widgets/Legend",
        "esri/widgets/Fullscreen",
      ], (
        FeatureLayer,
        CSVLayer,
        Map,
        SceneView,
        SimpleRenderer,
        PointSymbol3D,
        IconSymbol3DLayer,
        ObjectSymbol3DLayer,
        Expand,
        Legend,
        Fullscreen
      ) => {
        const doc = parent.document;
        doc.getElementById("icon-to-object").onclick = iconToObject;
        let symbol3D = false;

        /*****************************************************************
         * More than one visual variable can be set on a renderer to create
         * multivariate visualizations on a layer.
         *
         * In this case we set three visual variables on the renderer - one
         * for color and two for size. Because size values can be applied to
         * more than one axis in 3D (heigh, depth, and width) we want to
         * specify a constant value for the width and depth and size the
         * height of each feature based on the windspeed of the hurricane
         * at that location. Color is used to visualize atmospheric pressure.
         *****************************************************************/

        const visualVariables2D = [
          {
            type: "color",
            field: "depth",
            legendOptions: {
              title: "Depth",
            },
            stops: [
              {
                value: 1,
                color: [255, 0, 0, 0.5],
              },
              {
                value: 100,
                color: [0, 0, 255, 0.5],
              },
            ],
          },
          {
            type: "size",
            field: "mag",
            legendOptions: {
              title: "Magnitude",
            },
            stops: [
              {
                value: 4,
                size: 2,
              },
              {
                value: 8,
                size: 20,
              },
            ],
          },
        ];

        const getRenderer2D = function (visualVariablesInput) {
          return new SimpleRenderer({
            symbol: new PointSymbol3D({
              symbolLayers: [
                new IconSymbol3DLayer({
                  resource: { primitive: "circle" },
                  material: { color: [255, 0, 0, 0.8] },
                  size: 3,
                }),
              ],
            }),
            label: "Earthquake location",
            visualVariables: visualVariablesInput,
          });
        };
        const getRenderer3D = function () {
          return new SimpleRenderer({
            symbol: {
              type: "point-3d",
              symbolLayers: [
                {
                  type: "object",
                  resource: {
                    primitive: "sphere",
                  },
                  material: { color: [255, 250, 239, 0.8] },
                  depth: 10000,
                  height: 10000,
                  width: 10000,
                },
              ],
            },
            label: "Earthquake location",
            visualVariables: [
              {
                type: "size",
                field: "mag",
                axis: "all",
                stops: [
                  { value: 5.5, size: 70000, label: "<15%" },
                  { value: 7, size: 250000, label: "25%" },
                ],
              },
              {
                type: "color",
                field: "mag",
                legendOptions: {
                  title: "Magnitude",
                },
                stops: [
                  { value: 6, color: [254, 240, 217], label: "4.5 - 6" },
                  { value: 7, color: [179, 0, 0], label: ">7" },
                ],
              },
            ],
          });
        };
        const exaggeratedElevation = {
          mode: "absolute-height",
          featureExpressionInfo: {
            expression: "-$feature.depth * 6",
          },
          unit: "kilometers",
        };

        const realElevationOverground = {
          mode: "absolute-height",
          featureExpressionInfo: {
            expression: "$feature.depth*6",
          },
          //offset: 1000,
          unit: "kilometers",
        };
        const realElevation = {
          mode: "absolute-height",
          featureExpressionInfo: {
            expression: "-$feature.depth",
          },
          unit: "kilometers",
        };
        let exaggerated = true;

        // define the earthquakes layer
        const earthquakeLayer = new CSVLayer({
          url: "./demo-thematic/earthquake_data.csv",
          renderer: getRenderer2D(), //symbol3D ? renderer3D : renderer2D,
          elevationInfo: { mode: "on-the-ground" },
        });

        // add the layer to a new map
        const map = new Map({
          basemap: "oceans",
          layers: [earthquakeLayer],
        });

        // The initial camera of the view
        const initCam = {
          position: {
            spatialReference: {
              latestWkid: 3857,
              wkid: 102100,
            },
            x: -7634847.283479332,
            y: 59794.91411143105,
            z: 25512548.000000004,
          },
          heading: 0,
          tilt: 0.09999878152828588,
        };
        // add the map to a new 3d view
        const view = new SceneView({
          map: map,
          container: "viewDiv",
          camera: initCam,
        });

        earthquakeLayer.when(() => {
          const legendExpand = new Expand({
            view: view,
            content: new Legend({
              view: view,
            }),
            group: "bottom-right",
            expanded: false,
          });
          view.ui.add(legendExpand, "bottom-right");
        });

        function iconToObject() {
          symbol3D = !symbol3D;
          earthquakeLayer.renderer = symbol3D ? renderer3D : renderer2D;
        }
        const fullscreen = new Fullscreen({
          view: view,
        });
        view.ui.add(fullscreen, "bottom-left");
        view.popup.defaultPopupTemplateEnabled = true;

        window.addEventListener("keypress", onKeypress, false);
        function onKeypress(event) {
          //console.log(event);
          if (event.key == "1") {
            console.log("1");
            earthquakeLayer.renderer = getRenderer2D(visualVariables2D);
          } else if (event.key == "2") {
            console.log("2");
            earthquakeLayer.elevationInfo = {
              mode: "absolute-height",
              offset: 1000,
              unit: "kilometers",
            };
          } else if (event.key == "3") {
            console.log("3");
            earthquakeLayer.elevationInfo = realElevationOverground;
            //earthquakeLayer.renderer = getRenderer3D();
          } else if (event.key == "4") {
            console.log("4");
            earthquakeLayer.elevationInfo = realElevationOverground;
            earthquakeLayer.renderer = getRenderer3D();
          } else if (event.key == "5") {
          } else if (event.key == "6") {
          } else if (event.key == "7") {
          } else if (event.key == "c") {
            console.log(view.camera);
          }
        }
      });
    </script>
  </head>

  <body>
    <div id="viewDiv"></div>
  </body>
</html>
